@model ASI.Basecode.Services.ServiceModels.UserViewModel

@{
    ViewData["Title"] = "Agents";
    var roleMappings = new Dictionary<int, string>
    {
        { 1, "Admin" },
        { 2, "Agent" },
        { 3, "User" }
    };
}
@section styles {
    <link rel="stylesheet" href="~/css/functionalities.css" />
    <link rel="stylesheet" href="~/css/Admin.css" />
}

@Html.Partial("Admin_Header")
<div class="main">
    @Html.Partial("Admin_Sidebar")
    <div class="admin-body p-y-3 relative bg-grey">
        <div style="padding-right: 2rem; border-right: 1.5px solid #9E9E9E;">
            <h1>Agents and Team</h1>
            <div class="view-user-nav">
                <div class="agent-nav pt-4">
                    <ul class="flex-Row gap-2">
                        <a asp-action="ViewUser" class="nav-item active" data-nav-item>Agents</a>
                        <a asp-action="ViewTeams" class="nav-item" data-nav-item>Team</a>
                    </ul>
                </div>
                <div class="flex-Row gap-2 justify-content-center align-center">
                    <div class="j-search-container | flex-Row align-center justify-content-center">
                        <i class="fa-solid fa-magnifying-glass text-1-5"></i>
                        <input class="bg-transparent" type="text" placeholder="Search" />
                    </div>
                    <button class="mbtn-primary flex-Row gap-1 color-white bg-red align-center justify-content-center border-0 p-x-1 br-1-5" data-admin-add-btn>
                        <i class="fa-solid fa-user-plus"></i>
                        <p class="br-1-5 p-y-1">Add</p>
                    </button>
                </div>
            </div>
            <div class="flex-Row flex-between p-y-1 p-x-1 border-b-2 text-1-5 mb-3">
                <div class="flex-Row align-center gap-1 fw-semi">
                    <i class="fa-regular fa-user"></i>
                    <p>Profile</p>
                </div>
                <div class="flex-Row align-center gap-1 fw-semi">
                    <i class="fa-regular fa-address-card"></i>
                    <p>Name</p>
                </div>
                <div class="flex-Row align-center gap-1 fw-semi">
                    <i class="fa-solid fa-user-tie"></i>
                    <p>Role</p>
                </div>
            </div>
            @if (Model != null && Model.Users != null && Model.Users.Any())
            {
                <ul class="agents-container bg-white">
                    @foreach (var item in Model.Users)
                    {
                        <li class="agents | flex-Row flex-between p-y-1 p-x-1 align-center" data-viewuser-agent data-agents-1 data-user-id="@item.UserId">
                            <div class="user-img-profile br-50 bg-red"></div>
                            <div class="flex-col justify-content-center align-center">
                                <p class="fw-semi text-1-5">@Html.DisplayFor(modelItem => item.Name)</p>
                                <p>@Html.DisplayFor(modelItem => item.Email)</p>
                            </div>
                            <div class="role-container role-agent fw-semi text-0-5">@roleMappings[item.RoleId]</div>
                        </li>
                    }
                </ul>
            }
            else
            {
                <p>No agents available.</p>
            }
        </div>
        <div class="p-x-1 hidden" data-admin-edit-details>
            <!-- User Details Content Will Be Loaded Here -->
        </div>
        <div class="hidden modal-admin bg-modal" data-admin-modal-container>
            <div class="hidden modal-container br-1 bg-white p-y-1 p-x-2" data-modal-edit-form>
                <!-- Edit User Form Content Will Be Loaded Here -->
            </div>
            <div class="hidden modal-container br-1 bg-white p-y-1 p-x-2" data-modal-add-form>
                <!-- Add User Form Content Will Be Loaded Here -->
            </div>

        </div>

        <div class="hidden bg-modal delete-modal-container" data-admin-delete-modal-container>
            <div class="delete-modal flex flex-col gap-1 justify-content-center align-items-center" data-admin-delete-modal>
                <i class="text-md fa-regular fa-circle-xmark hover-pointer align-self-end" data-admin-delete-close-btn></i>
                <div class="flex-between flex-col align-items-center justify-content-center">
                    <i class="fa-solid fa-circle-exclamation color-error text-3"></i>
                    <h1>Are you sure?</h1>
                    <p>Do you really want to delete this user? This process cannot be undone</p>
                </div>
                <div class="flex-Row gap-2">
                    <button class="color-white bg-btn-accent align-center justify-content-center border-0 p-y-0-5 p-x-1 br-1-5" data-admin-delete-cancel-btn>Cancel</button>
                    <button class="mbtn-primary color-white bg-red align-center justify-content-center border-0 p-y-0-5 p-x-1 br-1-5" data-admin-delete-save-btn>Save</button>
                </div>
            </div>
        </div>
    </div>
    }

    @section scripts {
        <script>
            $(document).ready(function () {
                // Open modal on button click
                $('[data-admin-add-btn]').on('click', function () {
                    $.ajax({
                        url: '/AddUser',
                        type: 'GET',
                        success: function (data) {
                            // Populate the modal with the data returned from AddUser action
                            $('[data-modal-add-form]').html(data).closest('.modal-admin').removeClass('hidden');
                            $('[data-modal-add-form]').removeClass('hidden');
                        },
                        error: function (xhr, status, error) {
                            console.error('Error fetching AddUser view:', status, error);
                        }
                    });
                });

                // Handle form submission
                $(document).on('submit', '[data-modal-add-form] form', function (e) {
                    e.preventDefault();
                    var form = $(this);
                    $.ajax({
                        url: form.attr('action'),
                        type: 'POST',
                        data: form.serialize(),
                        success: function (response) {
                            // Handle successful form submission, such as closing the modal and updating the list
                            alert('User added successfully');
                            $('[data-modal-add-form]').closest('.modal-admin').addClass('hidden');
                            $('[data-modal-add-form]').addClass('hidden');
                            // You may also want to update the user list here
                        },
                        error: function (xhr, status, error) {
                            console.error('Error submitting form:', status, error);
                        }
                    });
                });

                // Close modal
                $(document).on('click', '[data-admin-add-close-btn], [data-admin-add-cancel-btn]', function () {
                    $('[data-modal-add-form]').closest('.modal-admin').addClass('hidden');
                    $('[data-modal-add-form]').addClass('hidden');
                });

                // Close the modal on clicking outside of it
                $('[data-admin-modal-container]').on('click', function () {
                    $(this).addClass('hidden');
                });

                // Show user details on list item click
                $(document).on('click', '[data-viewuser-agent]', function () {
                    var userId = $(this).data('user-id');
                    $.ajax({
                        url: '/UserDetails',
                        type: 'GET',
                        data: { UserId: userId },
                        success: function (response) {
                            $('[data-admin-edit-details]').html(response).removeClass('hidden');
                        },
                        error: function (xhr, status, error) {
                            console.error('Error fetching user details:', status, error);
                        }
                    });
                });

                // Show user edit details on edit button click
                $(document).on('click', '[data-admin-edit-btn]', function () {
                    var userId = $(this).data('user-id');
                    console.log('Edit button clicked. UserId:', userId);

                    $.ajax({
                        url: '/UserEdit',
                        type: 'GET',
                        data: { UserId: userId },
                        success: function (response) {
                            console.log('AJAX request successful');
                            $('[data-admin-edit-details]').html(response).removeClass('hidden');
                        },
                        error: function (xhr, status, error) {
                            console.error('Error fetching user details:', status, error);
                        }
                    });
                });
            });
        </script>
    }
